<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="material_style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.1/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <title>Material Stock Inventory</title>
</head>
<body>

    <div class="header">
        <img src="logo_new.png" alt="Logo" class="logo" width="130px" height="100px">
        <div class="header-text">
            <header>ğ“ğ‘ğ€ğğ’ğŒğˆğ’ğ’ğˆğğ ğ‚ğğ‘ğğğ‘ğ€ğ“ğˆğğ ğğ… ğ“ğ„ğ‹ğ€ğğ†ğ€ğğ€ ğ‹ğˆğŒğˆğ“ğ„ğƒ</header>
            <header class="material-stock">Material Stock Inventory</header>
        </div>
        <button id="logout-btn" class="logout-btn">
            <i class="fas fa-sign-out-alt"></i> Logout
        </button>
    </div>
    
  <div class="container">
    <div class="dashboard">
      <h2 id="dashboard-heading">Dashboard</h2>
      <p id="lastUpdated">Last Updated: Loading...</p>
      <div class="download-buttons">
        <button id="download-excel-btn">
            <i class="fas fa-file-csv"></i>
        </button>
        <button id="download-pdf-btn">
            <i class="fas fa-file-pdf"></i>
        </button>
    </div>
    
      <!-- Add this search bar above the summary table -->
    <div class="search-container">
        <input type="text" id="search-bar" placeholder="Search by material name or type..." />
    </div>  
      <table class="summary-table">
        <thead>
          <tr>
            <th>S.No</th>
            <th>Material Type</th>
            <th>Total Available Stock</th>
            <th>Total Used/Dispatched</th>
            <th>Total Material</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody id="material-summary-container">
          <!-- Material summaries will be dynamically added here -->
        </tbody>
      </table>
    </div>

    <div class="stock-form">
      <h2>Add/Edit Material</h2>

      <label for="material-type">Material Type</label>
      <select id="material-type">
        <option value="">Select type</option>
        <option value="400KV CVT">400KV CVT</option>
        <option value="400KV CT">400KV CT</option>
        <option value="400KV LA">400KV LA</option>
        <option value="400KV CB">400KV CB</option>
        <option value="220KV CVT">220KV CVT</option>
        <option value="220KV PT">220KV PT</option>
        <option value="220KV CT">220KV CT</option>
        <option value="220KV LA">220KV LA</option>
        <option value="220KV CB">220KV CB</option>
        <option value="315MVA">315MVA ICT</option>
        <option value="500MVA">500MVA ICT</option>
      </select>

      <label for="material-name">Material Name</label>
      <input type="text" id="material-name" placeholder="Enter material name">

      <label for="material-stock">Stock Available Quantity</label>
      <input type="number" id="material-stock" placeholder="Enter stock quantity">

      <label for="material-dispatched">Used/Dispatched Quantity</label>
      <input type="number" id="material-dispatched" placeholder="Enter dispatched quantity">

      <label for="material-remarks">Add Remark</label>
      <input type="text" id="material-remarks" placeholder="Enter remark">

      <button id="add-btn">Add/Update Material</button>
    </div>

    <!-- Add this to your HTML -->
    <div id="popup-message" class="popup" style="display: none;">
        <div id="popup-content" class="popup-content">
        <span id="popup-close" class="popup-close">&times;</span>
        <p id="popup-text"></p>
        </div>
    </div>    

    <!-- Edit Material Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
        <span id="close-modal" class="close">&times;</span>
        <h2>Edit Material</h2>
        <label for="edit-material-type">Material Type</label>
        <input type="text" id="edit-material-type" disabled>
    
        <label for="edit-material-name">Material Name</label>
        <input type="text" id="edit-material-name" disabled>
    
        <label for="edit-material-dispatched">Dispatched Quantity</label>
        <input type="number" id="edit-material-dispatched" placeholder="Enter dispatched quantity">
    
        <label for="edit-material-remarks">Remarks</label>
        <input type="text" id="edit-material-remarks" placeholder="Enter remarks">
    
        <button id="save-edit-btn">Save Changes</button>
        </div>
    </div>    

    <div class="stock-table">
        <h2>Current Stock</h2>
        <table id="stock-table">
          <thead>
            <tr>
              <th>S.No</th>
              <th>Material Name</th>
              <th>Material Type</th>
              <th>Available Stock</th>
              <th>Used/Dispatched</th>
              <th>Total Material</th>
              <th>Remarks</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="stock-list">
            <!-- Dynamic rows go here -->
          </tbody>
        </table>
        <!-- Buttons for print and download -->
        <div class="table-actions">
          <button id="print-btn" class="action-btn">Print</button>
        </div>
      </div>      
  </div>

  <script>
    const materialNameInput = document.getElementById('material-name');
    const materialTypeInput = document.getElementById('material-type');
    const materialStockInput = document.getElementById('material-stock');
    const materialDispatchedInput = document.getElementById('material-dispatched');
    const materialRemarksInput = document.getElementById('material-remarks');
    const addButton = document.getElementById('add-btn');
    const stockList = document.getElementById('stock-list');
    const materialSummaryContainer = document.getElementById('material-summary-container');
    const popupMessage = document.getElementById('popup-message');
    const popupText = document.getElementById('popup-text');
    const popupClose = document.getElementById('popup-close');
    const lastUpdatedElement = document.getElementById('lastUpdated');
    const editMaterialTypeInput = document.getElementById('edit-material-type');
    const editMaterialNameInput = document.getElementById('edit-material-name');
    const editMaterialDispatchedInput = document.getElementById('edit-material-dispatched');
    const editMaterialRemarksInput = document.getElementById('edit-material-remarks');
    const saveEditBtn = document.getElementById('save-edit-btn');
    const editModal = document.getElementById('edit-modal');
    const closeModalBtn = document.getElementById('close-modal');

    let materials = [];
    let editingIndex = -1;

    // Utility function to format date as DD-MM-YYYY HH:mm:ss
    function formatDate(dateString) {
        if (!dateString) return "Unknown";  // âœ… Handle null values
        const date = new Date(dateString);
        const d = date.getDate().toString().padStart(2, '0');
        const m = (date.getMonth() + 1).toString().padStart(2, '0');
        const y = date.getFullYear();
        const h = date.getHours().toString().padStart(2, '0');
        const min = date.getMinutes().toString().padStart(2, '0');
        return `${d}-${m}-${y} ${h}:${min}`;
    }

    // Function to update the last updated date and time
    function updateLastUpdated(action) {
    const lastUpdatedElement = document.getElementById("lastUpdated");

    if (lastUpdatedElement) {
        const lastUpdatedFromStorage = localStorage.getItem("lastUpdated");
        if (lastUpdatedFromStorage) {
            const formattedDate = new Date(lastUpdatedFromStorage).toLocaleString();
            lastUpdatedElement.textContent = `Last Updated: ${formattedDate}`;
        } else {
            console.log('No last updated timestamp found in localStorage.');
            lastUpdatedElement.textContent = 'Last Updated: No data available';  // Show message if no data
        }
    } else {
        console.error('Element with ID "lastUpdated" not found.');
    }
}


    // Function to load the last updated date and time from localStorage
    window.onload = function() {
    loadLastUpdated();  // Call to display the last updated timestamp
    fetchMaterials();    // Fetch materials and update the dashboard
};

function loadLastUpdated() {
    const lastUpdatedElement = document.getElementById('lastUpdated');

    if (lastUpdatedElement) {
        const lastUpdatedFromStorage = localStorage.getItem('lastUpdated');
        if (lastUpdatedFromStorage) {
            const formattedDate = new Date(lastUpdatedFromStorage).toLocaleString();
            lastUpdatedElement.textContent = `Last Updated: ${formattedDate}`;
        } else {
            console.log('No last updated timestamp found in localStorage.');
            lastUpdatedElement.textContent = 'Last Updated: No data available';  // Show message if no data
        }
    } else {
        console.error('Element with ID "lastUpdated" not found.');
    }
}



    function updateLastUpdatedOnUI(latestLastUpdated) {
        const lastUpdatedElement = document.getElementById('lastUpdated'); // Assuming you have an element with this ID to show the timestamp
        const formattedDate = new Date(latestLastUpdated).toLocaleString(); // Format the date in a user-friendly format
        if (lastUpdatedElement) {
            lastUpdatedElement.textContent = `Last Updated: ${formattedDate}`;
        } else {
            console.error('Element with ID "lastUpdated" not found.');
        }
    }

    function saveLastUpdatedToLocalStorage(latestLastUpdated) {
        localStorage.setItem('lastUpdated', latestLastUpdated);
    }

    // Render the material stock and summary
    function renderStock(filteredMaterials = materials) {
        stockList.innerHTML = ''; // Clear table before rendering

        filteredMaterials.forEach((material, index) => {
            const { name, type, stock, dispatched, remarks, addedDate, lastUpdated, dispatchHistory } = material;
            const totalMaterial = stock + dispatched;

            // âœ… Fix: Ensure remarks is an array and all values are strings
            const displayRemarks = Array.isArray(remarks) && remarks.length > 0
                ? remarks.map(r => (typeof r === "string" ? r.trim() : "Nil"))
                : ["Nil"];

            let addedDateFormatted = addedDate ? formatDate(new Date(addedDate)) : "Unknown";
            let lastUpdatedFormatted = lastUpdated ? formatDate(new Date(lastUpdated)) : "Unknown";

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>
                    <small style="color: red; font-size: 12px;">Added: ${addedDateFormatted}</small>
                    <br>
                    <strong>${name}</strong>
                    <br>
                    ${dispatchHistory && dispatchHistory.length > 0
                        ? dispatchHistory.map(d => `
                            <small style="color: blue; font-size: 12px;">
                                Dispatched: ${d.quantity} No's, Date: ${formatDate(new Date(d.date))}, 
                                Remarks: ${d.remarks ? d.remarks : "Nil"}
                            </small><br>`).join("")
                        : ""
                    }
                </td>
                <td>${type}</td>
                <td>${stock}</td>
                <td>${dispatched}</td>
                <td>${totalMaterial}</td>
                <td>
                    <ul class="remarks-list">
                        ${displayRemarks.map(r => `<li>${r}</li>`).join('')}
                    </ul>
                </td>
                <td>
                    <button class="edit-btn" onclick="editMaterial(${index})">Edit</button>
                    <button class="delete-btn" onclick="deleteMaterial(${index})">Delete</button>
                </td>
            `;
            stockList.appendChild(row);
        });
    }

    // Helper function to create a material row
    function createMaterialRow(material, index) {
        const { name, type, stock, dispatched, remarks } = material;
        const totalMaterial = stock + dispatched;
        const displayRemarks = remarks.length === 0 || remarks[0].trim() === "" ? ["Nil"] : remarks;

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${index + 1}</td>
            <td>${name}</td>
            <td>${type}</td>
            <td>${stock}</td>
            <td>${dispatched}</td>
            <td>${totalMaterial}</td>
            <td>
                <ul class="remarks-list">
                    ${displayRemarks.map(r => `<li>${r}</li>`).join('')}
                </ul>
            </td>
            <td>
                <button class="edit-btn" onclick="editMaterial(${index})">Edit</button>
                <button class="delete-btn" onclick="deleteMaterial(${index})">Delete</button>
            </td>
        `;
        return row;
    }

    // Render the summary dashboard
    function renderDashboard(summaryMap) {
        materialSummaryContainer.innerHTML = ''; // Clear existing summary content
        let serialNumber = 1;

        for (const type in summaryMap) {
            const { totalStock, totalDispatched, totalMaterial, materials } = summaryMap[type];

            const summaryRow = document.createElement('tr');
            summaryRow.innerHTML = `
                <td>${serialNumber++}</td>
                <td>${type}</td>
                <td>${totalStock}</td>
                <td>${totalDispatched}</td>
                <td>${totalMaterial}</td>
                <td>
                    <ul class="remarks-list">
                        ${materials.map(material => {
                            const displayRemarks = Array.isArray(material.remarks) && material.remarks.length > 0
                                ? material.remarks.map(r => (typeof r === "string" ? r.trim() : "Nil"))
                                : ["Nil"];

                            return ` 
                                <li>
                                    ${material.name}: Stock - ${material.stock}, Dispatched - ${material.dispatched}, Total - ${material.stock + material.dispatched}
                                    <ul class="remarks-list">
                                        ${displayRemarks.map(r => `<li>${r}</li>`).join('')}
                                    </ul>
                                </li>
                            `;
                        }).join('')}
                    </ul>
                </td>
            `;
            materialSummaryContainer.appendChild(summaryRow);
        }
    }

    function updateSummaryMap(summaryMap, updatedMaterial) {
        const { type, stock, dispatched, remarks } = updatedMaterial;

        if (summaryMap[type]) {
            // Find the material inside the type's material list
            const materialIndex = summaryMap[type].materials.findIndex(m => m._id === updatedMaterial._id);
            
            if (materialIndex !== -1) {
                // Update the material details
                summaryMap[type].materials[materialIndex].stock = stock;
                summaryMap[type].materials[materialIndex].dispatched = dispatched;
                summaryMap[type].materials[materialIndex].remarks = remarks;
            }

            // Recalculate totals
            summaryMap[type].totalStock = summaryMap[type].materials.reduce((sum, m) => sum + m.stock, 0);
            summaryMap[type].totalDispatched = summaryMap[type].materials.reduce((sum, m) => sum + m.dispatched, 0);
            summaryMap[type].totalMaterial = summaryMap[type].totalStock + summaryMap[type].totalDispatched;
        }
    }

    // Function to fetch materials from the server
    document.addEventListener('DOMContentLoaded', function () {
    fetchMaterials();
});

async function fetchMaterials() {
     try {
         const response = await fetch('https://stock-register-git-main-vinay-kumars-projects-f1559f4a.vercel.app/api/materials');
         if (!response.ok) throw new Error("Failed to fetch materials.");

         materials = await response.json();

         console.log("Fetched Materials:", materials);  // âœ… Debugging line

         // Initialize the variable to hold the most recent date
         let mostRecentDate = null;

         materials.forEach(material => {
             material.remarks = Array.isArray(material.remarks) 
                 ? material.remarks.map(r => (typeof r === "object" && r !== null ? r : { text: "Nil" })) 
                 : [];

             material.addedDateFormatted = material.addedDate ? formatDate(new Date(material.addedDate)) : "Unknown";
             material.lastUpdatedFormatted = material.lastUpdated ? formatDate(new Date(material.lastUpdated)) : "Unknown";

             // Update mostRecentDate if this material's lastUpdated is more recent
             if (material.lastUpdated) {
                 const materialLastUpdated = new Date(material.lastUpdated);
                 if (!mostRecentDate || materialLastUpdated > mostRecentDate) {
                     mostRecentDate = materialLastUpdated;
                 }
             }
         });

         const formattedMostRecentDate = mostRecentDate ? formatDate(mostRecentDate) : "No updates available";

         // Save the most recent date to localStorage
         if (mostRecentDate) {
             localStorage.setItem('lastUpdated', mostRecentDate.toISOString()); // Store the ISO string of the date
             console.log("Saved lastUpdated to localStorage:", mostRecentDate.toISOString());  // âœ… Debugging line
         }

         renderStock();
         renderDashboard(calculateSummary(materials));

         // Display the most recent update date and time in the dashboard
         const lastUpdatedElement = document.getElementById("lastUpdated");
         if (lastUpdatedElement) {
             lastUpdatedElement.textContent = `Last Updated: ${formattedMostRecentDate}`;
         }
     } catch (error) {
         console.error("Error fetching materials:", error);
     }
 }


// Helper function for formatting dates
function formatDate(date) {
    return date.toLocaleString(); // Simple format: "MM/DD/YYYY, HH:MM:SS"
}


    // Calculate summary data for dashboard
    function calculateSummary(materials) {
        const summaryMap = {};

        materials.forEach((material) => {
            const { type, stock, dispatched, remarks } = material;
            const totalMaterial = stock + dispatched;

            if (!summaryMap[type]) {
                summaryMap[type] = { totalStock: 0, totalDispatched: 0, totalMaterial: 0, materials: [] };
            }

            summaryMap[type].totalStock += stock;
            summaryMap[type].totalDispatched += dispatched;
            summaryMap[type].totalMaterial += totalMaterial;
            summaryMap[type].materials.push(material);
        });

        return summaryMap;
    }

    async function addOrUpdateMaterial() {
    const existingMaterial = editingIndex !== -1 ? materials[editingIndex] : null;

    const material = {
        name: materialNameInput.value.trim(),
        type: materialTypeInput.value,
        stock: parseInt(materialStockInput.value, 10) || 0,
        dispatched: parseInt(materialDispatchedInput.value, 10) || 0,
        remarks: materialRemarksInput.value.trim() ? [{ text: materialRemarksInput.value.trim() }] : [],
        addedDate: existingMaterial ? existingMaterial.addedDate : new Date().toISOString(),
        lastUpdated: new Date().toISOString() // Set the current timestamp
    };

    const method = existingMaterial ? "PUT" : "POST";
    const url = existingMaterial
        ? `https://stock-register-git-main-vinay-kumars-projects-f1559f4a.vercel.app/api/materials/${existingMaterial._id}`
        : "https://stock-register-git-main-vinay-kumars-projects-f1559f4a.vercel.app/api/materials";

    try {
        const response = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(material),
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`Failed to add/update material: ${errorData.message}`);
        }

        console.log("Material successfully added/updated.");

        // Save the last updated timestamp to localStorage in ISO format
        const lastUpdatedDate = new Date().toISOString();
        localStorage.setItem('lastUpdated', lastUpdatedDate);

        showSuccessPopup(existingMaterial ? "Material Updated Successfully" : "Material Added Successfully");

        await fetchMaterials(); // Refresh data
        clearForm(); // Clear form fields
        renderDashboard(calculateSummary(materials)); // Update dashboard

        // Update the dashboard with the most recent update time
        updateLastUpdated("Material Updated");

    } catch (error) {
        console.error("Error during material add/update:", error);
        alert("An error occurred while adding/updating the material.");
    }
}



    // âœ… Function to show success popup
    function showSuccessPopup(message) {
        const popup = document.createElement("div");
        popup.innerText = message;
        popup.style.position = "fixed";
        popup.style.top = "20px";
        popup.style.left = "50%";
        popup.style.transform = "translateX(-50%)";
        popup.style.backgroundColor = "#4CAF50";
        popup.style.color = "#fff";
        popup.style.padding = "10px 20px";
        popup.style.borderRadius = "5px";
        popup.style.zIndex = "1000";
        popup.style.boxShadow = "0 4px 8px rgba(0, 0, 0, 0.2)";
        
        document.body.appendChild(popup);

        // Remove popup after 3 seconds
        setTimeout(() => {
            popup.remove();
        }, 3000);
    }

    // âœ… Function to clear form fields after submission
    function clearForm() {
        materialNameInput.value = "";
        materialTypeInput.value = "";
        materialStockInput.value = "";
        materialDispatchedInput.value = "";
        materialRemarksInput.value = "";
        editingIndex = -1; // Reset editing state
    }

    // Delete material
    async function deleteMaterial(index) {
    const confirmDelete = confirm("Are you sure you want to delete this material?");
    if (!confirmDelete) return; // Stop if the user cancels

    try {
        if (!materials || !materials[index]) {
            alert("Material not found!");
            return;
        }

        const id = materials[index]._id;
        const response = await fetch(`https://stock-register-git-main-vinay-kumars-projects-f1559f4a.vercel.app/api/materials/${id}`, { 
            method: "DELETE" 
        });

        if (response.ok) {
            showMessage("Material deleted successfully!", "delete");

            // Refresh the list of materials and update the dashboard
            await fetchMaterials(); // Refresh materials list
            renderDashboard(calculateSummary(materials)); // Update the dashboard based on new data

            // Update last updated timestamp in localStorage
            const now = new Date();
            localStorage.setItem('lastUpdated', formatDate(now));

            // Update the UI with the last updated timestamp
            updateLastUpdated('Material deleted');
        } else {
            const errorMsg = await response.text();
            console.error("Failed to delete material:", errorMsg);
            alert(`Failed to delete material: ${errorMsg}`);
        }
    } catch (error) {
        console.error("Error deleting material:", error);
        alert("An error occurred while deleting the material.");
    }
}

    // Function to show message in popup
    function showMessage(message, type) {
        popupText.textContent = message;
        popupText.className = type; // Add success or delete class for different styles
        popupMessage.style.display = "flex"; // Show the popup

        // Close the popup after 3 seconds
        setTimeout(() => {
            popupMessage.style.display = "none";
        }, 1500);
    }

    // Edit material
    function editMaterial(index) {
        editingIndex = index;
        if (index < 0 || index >= materials.length) {
            alert("Invalid material index.");
            return;
        }

        const material = materials[index];

        // Pre-fill modal form fields with material data
        editMaterialNameInput.value = material.name;
        editMaterialTypeInput.value = material.type;
        editMaterialDispatchedInput.value = ""; // Clear previous dispatched input

        // âœ… Ensure remarks field is empty if there are no valid remarks
        editMaterialRemarksInput.value = material.remarks && material.remarks.length > 0 
            ? material.remarks
                .map(r => (typeof r === "object" && r.text ? r.text : ""))
                .filter(r => r.trim() !== "") // Remove empty remarks
                .join(", ") 
            : ""; // If no remarks, make the field empty

        editModal.style.display = "block"; // Show modal
    }

    // Initialize summaryMap at the beginning
    let summaryMap = {};  // Ensure this is declared before it's used

    // Edit material function
    saveEditBtn.addEventListener("click", async function () {
    if (editingIndex !== -1) {
        const dispatchedQty = parseInt(editMaterialDispatchedInput.value, 10);
        if (isNaN(dispatchedQty) || dispatchedQty < 0) {
            alert("Please enter a valid dispatched quantity.");
            return;
        }

        const remarks = editMaterialRemarksInput.value.trim() ? [editMaterialRemarksInput.value.trim()] : ["Nil"];
        const now = new Date();
        const lastUpdatedFormatted = now.toISOString();

        let material = materials[editingIndex];

        if (material.stock >= dispatchedQty) {
            material.stock -= dispatchedQty;
            material.dispatched += dispatchedQty;
            material.remarks.push(...remarks);
            material.lastUpdatedFormatted = lastUpdatedFormatted;

            if (!material.dispatchHistory) {
                material.dispatchHistory = [];
            }
            material.dispatchHistory.push({
                quantity: dispatchedQty,
                date: lastUpdatedFormatted,
                remarks: remarks.join(", ")
            });

            try {
                const response = await fetch(`https://stock-register-git-main-vinay-kumars-projects-f1559f4a.vercel.app/api/materials/${materials[editingIndex]._id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(material),
                });

                console.log('Server Response Status:', response.status);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Failed to update: ${errorData.message || 'Unknown error'}`);
                }

                const data = await response.json();
                console.log("Server Response:", data);

                if (data.success) {
                    alert("Material updated successfully.");
                    updateLastUpdated("Material Edited");

                    // âœ… Immediately refresh materials list and dashboard
                    await fetchMaterials();

                    // âœ… Close the modal after update
                    editModal.style.display = "none";

                    // Save the last updated timestamp to localStorage
                    localStorage.setItem('lastUpdated', lastUpdatedFormatted);  // Update local storage
                } else {
                    alert("Failed to update material: " + (data.message || "Unknown error"));
                }
            } catch (error) {
                console.error("Error updating material:", error);

                if (error.message.includes("Failed to update")) {
                    alert("Material update failed: " + error.message);
                } else if (!navigator.onLine) {
                    alert("No internet connection. Please check your network.");
                } else {
                    alert("A network error occurred. Please try again.");
                }
            }
        } else {
            alert("Not enough stock available for dispatch!");
        }
    }
});


    // Function to download the summary as Excel
    function downloadExcel() {
        const rows = [];
        const headers = ["S.No", "Material Type", "Total Available Stock", "Total Used/Dispatched", "Total Material", "Details"];
        rows.push(headers); // Add headers to the first row

        let serialNumber = 1;
        const materialRows = document.querySelectorAll('#material-summary-container tr');
        materialRows.forEach(row => {
            const cols = row.querySelectorAll('td');
            const rowData = [
                serialNumber++,
                cols[1].textContent,
                cols[2].textContent,
                cols[3].textContent,
                cols[4].textContent,
                cols[5].textContent
            ];
            rows.push(rowData); // Add row data
        });

        const ws = XLSX.utils.aoa_to_sheet(rows); // Convert rows to Excel sheet
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Material Summary");

        // Download the Excel file
        XLSX.writeFile(wb, "Material_Inventory_Summary.xlsx");
    }

    // Function to download the summary as PDF
    function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('landscape'); // Set the orientation to landscape
        const pageWidth = doc.internal.pageSize.getWidth(); // Get page width in landscape
        let y = 10;

        // Title: "TRANSMISSION CORPORATION OF TELANGANA LIMITED"
        doc.setFontSize(22);
        doc.setFont("Arial", "bold");
        const titleText1 = "TRANSMISSION CORPORATION OF TELANGANA LIMITED";
        const titleWidth1 = doc.getStringUnitWidth(titleText1) * doc.internal.getFontSize() / doc.internal.scaleFactor;
        const titleX1 = (pageWidth - titleWidth1) / 2; // Calculate horizontal center
        doc.text(titleText1, titleX1, y);
        y += 20; // Increase space after the first title

        // Add underline below the title
        doc.setLineWidth(0.5); // Set the line width for the underline
        doc.line(titleX1, y - 10, titleX1 + titleWidth1, y - 10); // Draw the line for the underline

        // Title: "Material Inventory Summary"
        doc.setFontSize(18);
        doc.setFont("Arial", "normal");
        const titleText2 = "Material Inventory Summary";
        const titleWidth2 = doc.getStringUnitWidth(titleText2) * doc.internal.getFontSize() / doc.internal.scaleFactor;
        const titleX2 = (pageWidth - titleWidth2) / 2; // Calculate horizontal center
        doc.text(titleText2, titleX2, y);

        // Remove space between title and table headers by setting y directly for table headers
        y += 5; // Slight space between title and header

        // Define column widths for the 5 columns (excluding "Details")
        const columnWidths = [20, 50, 50, 60, 60]; // Adjust widths to fit the page

        // Headers (without the 'Details' column)
        const headers = ["S.No", "Material Type", "Total Available Stock", "Total Used/Dispatched", "Total Material"];
        const headerStyles = {
            font: "Arial",
            size: 12, // Decreased font size for headers
            bold: true,
            color: [255, 255, 255], // White text color
            backgroundColor: [50, 50, 150] // Blue background color
        };

        // Set table header styles
        doc.setFont(headerStyles.font, 'bold');
        doc.setFontSize(headerStyles.size); // Apply decreased font size
        doc.setTextColor(headerStyles.color[0], headerStyles.color[1], headerStyles.color[2]);
        doc.setFillColor(headerStyles.backgroundColor[0], headerStyles.backgroundColor[1], headerStyles.backgroundColor[2]);

        // Draw the header at the top
        doc.rect(14, y, columnWidths[0] + columnWidths[1] + columnWidths[2] + columnWidths[3] + columnWidths[4], 12, 'F'); // Draw background for header
        doc.text(headers[0], 16, y + 8);
        doc.text(headers[1], 34, y + 8);
        doc.text(headers[2], 84, y + 8);
        doc.text(headers[3], 144, y + 8);
        doc.text(headers[4], 204, y + 8);
        y += 14; // Increase space after headers

        // Set row styles
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0); // Black text
        const materialRows = document.querySelectorAll('#material-summary-container tr');
        let serialNumber = 1;

        // Loop through rows and print data with automatic text wrapping
        materialRows.forEach(row => {
            const cols = row.querySelectorAll('td');
            const rowData = [
                serialNumber++,
                cols[1].textContent,
                cols[2].textContent,
                cols[3].textContent,
                cols[4].textContent
            ];

            // Add data to PDF with automatic text wrapping
            doc.text(rowData[0].toString(), 14, y + 7);
            doc.text(rowData[1], 34, y + 7, { maxWidth: columnWidths[1] }); // Wrap text in column 2
            doc.text(rowData[2], 84, y + 7, { maxWidth: columnWidths[2] }); // Wrap text in column 3
            doc.text(rowData[3], 144, y + 7, { maxWidth: columnWidths[3] }); // Wrap text in column 4
            doc.text(rowData[4], 204, y + 7, { maxWidth: columnWidths[4] }); // Wrap text in column 5

            y += 12; // Add space between rows
        });

        // Save the PDF
        doc.save("Material_Inventory_Summary.pdf");
    }

    // Event listeners for download buttons
    document.getElementById('download-excel-btn').addEventListener('click', downloadExcel);
    document.getElementById('download-pdf-btn').addEventListener('click', downloadPDF);

    document.addEventListener("DOMContentLoaded", function() {

    // Print Button Functionality
    document.getElementById("print-btn").addEventListener("click", function() {
        const stockTable = document.getElementById("stock-table"); // table has the ID "stock-table"
        if (stockTable) {
            // Hide the 'Actions' column (assuming it's the last column)
            const rows = stockTable.querySelectorAll("tr");
            rows.forEach(row => {
            const actionsCell = row.querySelector("td:last-child, th:last-child"); // targeting the last column (Actions)
            if (actionsCell) {
                actionsCell.style.display = "none"; // Hide the cell
            }
            });

            // Create a title element with reduced font size and margin for spacing
            const title = `<h1 style="text-align: center; font-size: 22px; margin-bottom: 30px;">TRANSMISSION CORPORATION OF TELANGANA LIMITED</h1>`;
            
            // Combine the title and the table HTML
            const printContents = title + stockTable.outerHTML;
            
            // Save the original contents of the page
            const originalContents = document.body.innerHTML;
            
            // Replace the body with the title and the table for printing
            document.body.innerHTML = printContents;
            
            // Print the page
            window.print();
            
            // Restore the original contents of the page
            document.body.innerHTML = originalContents;
            
            // After printing, make the "Actions" column visible again
            rows.forEach(row => {
            const actionsCell = row.querySelector("td:last-child, th:last-child");
            if (actionsCell) {
                actionsCell.style.display = ""; // Restore the cell visibility
            }
            });
        } else {
            console.error("Table not found");
        }
    });

    document.getElementById("download-excel-btn").addEventListener("click", function() {
        const stockTable = document.getElementById("stock-table");
        if (stockTable) {
            let csv = [];
            
            // Get the headers
            const headers = stockTable.querySelectorAll("th");
            let headerRow = [];
            headers.forEach((header, index) => {
                // Exclude the last header (assuming it's the "Action" column)
                if (index < headers.length - 1) {
                    headerRow.push(header.innerText);
                }
            });
            csv.push(headerRow.join(","));
            
            // Get the table rows
            const rows = stockTable.querySelectorAll("tbody tr");
            rows.forEach(row => {
                let rowData = [];
                const cells = row.querySelectorAll("td");
                cells.forEach((cell, index) => {
                    // Exclude the last cell (assuming it's the "Action" column)
                    if (index < cells.length - 1) {
                        rowData.push(cell.innerText);
                    }
                });
                if (rowData.length > 0) {
                    csv.push(rowData.join(","));
                }
            });
            
            // Convert the CSV to Blob
            const csvBlob = new Blob([csv.join("\n")], { type: "text/csv" });
            const downloadLink = document.createElement("a");
            downloadLink.href = URL.createObjectURL(csvBlob);
            downloadLink.download = "stock_data.csv"; // Filename
            downloadLink.click();
        } else {
            console.error("Table not found");
        }
    });
    });

    // Search functionality
    document.getElementById('search-bar').addEventListener('input', function () {
        const query = this.value.toLowerCase().trim();  // Get search query in lowercase

        // Filter materials based on the search query
        const filteredMaterials = materials.filter(material => 
            material.name.toLowerCase().includes(query) ||   // Match material name
            material.type.toLowerCase().includes(query) ||   // Match material type
            (Array.isArray(material.remarks) && material.remarks.some(
                remark => typeof remark === 'string' && remark.toLowerCase().includes(query)
            ))  // Match remarks safely
        );

        // Render the stock table with filtered materials
        renderStock(filteredMaterials);

        // Recalculate and render the dashboard summary with filtered materials
        renderDashboard(calculateSummary(filteredMaterials));
    });

    // Event listeners
    addButton.addEventListener('click', addOrUpdateMaterial);
    closeModalBtn.addEventListener('click', () => { editModal.style.display = 'none'; });
    popupClose.addEventListener('click', () => { popupMessage.style.display = 'none'; });

    window.addEventListener('DOMContentLoaded', () => {
        loadLastUpdated();
        fetchMaterials(); // Load materials on page load
    });

    (async function checkLoginStatus() {
        try {
            const response = await fetch("https://stock-register-git-main-vinay-kumars-projects-f1559f4a.vercel.app/check-login", { 
            method: "GET",
            credentials: "include" // If using cookies for authentication
            });

            if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
            }

            const result = await response.json();
            
            if (!result.loggedIn) {
            window.location.href = "/login.html"; // Redirect if not logged in
            }
        } catch (error) {
            console.error("Login check failed:", error);
        }
    })();


    document.getElementById('logout-btn').addEventListener('click', async function() {
        // Send request to backend to destroy session
        const response = await fetch("/logout", { method: "POST" });
        const result = await response.json();

        if (result.success) {
            // Clear session storage, cookies, and cache
            sessionStorage.clear();
            localStorage.clear();
            sessionStorage.setItem('logout', 'true');
            document.cookie.split(';').forEach(function(c) {
                document.cookie = c.trim().split('=')[0] + '=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/';
            });

            // Redirect to login page after clearing session and cookies
            window.location.href = '/login.html'; // Redirect to login page
        } else {
            console.error('Logout failed', result.message);
        }
    });

    // Prevent back navigation
    if (window.location.pathname === '/login.html') {
        history.pushState(null, null, location.href);
        window.onpopstate = function() {
            history.pushState(null, null, location.href); // Keep the user on the login page
        };
    }

</script>
</body>
</html>
